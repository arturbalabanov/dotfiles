# For the zsh theme -- if the user is DEFAULT_USER, it is not shown
export DEFAULT_USER="arturb"

export GOPATH=$HOME/go
export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin

alias pgcli='~/side/pgcli/venv/bin/pgcli'

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm

function venv {
    source venv/bin/activate && export PYTHONPATH=`pwd`;
}

function pgssh {
	if [[ "$#" -ne 2 ]]; then
		echo "Usage: $0 <container> <db name>"
		return 1
	fi

	container="$1"
	db_name="$2"

	if [[ $container == 'live' ]]; then
		container="${db_name}db"
		username='readonly'
		password='r3ad0nly'
	else
		username='colin'
		password='c0l1n'
	fi

	export PGPASSWORD="$password"
	pgcli -h $container -U "$username" $db_name
}

function logssh {
	if [[ "$#" -lt 2 ]]; then
		echo "Usage: $0 <container> <service> [<editor>]"
		return 1
	fi

	orig_dir=$(pwd)

	container="$1"
	service="$2"

	if [[ "$#" -eq 3 ]]; then
		editor="$3"
	else
		editor="$EDITOR"
	fi

	logs_dir=$(mktemp -d)
	combined_log=$(mktemp)

	scp $USER@$container:/var/log/colin/$service.log* $logs_dir
	
	cd $logs_dir
	for gz_log in *.gz; do
		gunzip $gz_log
	done
	
	cat $(ls | sort -n -t '.' -k 3 -r) | sed 's:#012:\n:g' > $combined_log

	cd $orig_dir
	rm -r $logs_dir

	$editor $combined_log
	rm $combined_log
}

function jira-links {
	MAIN_GITLAB='https://gitlab.mustardsystems.com/mustard'
	MAIN_PHABRICATOR='https://phabricator.mustardsystems.com'

	DEFAULT_REPO='colinbet'

	for handle in ${(z)1}; do
		if [[ $handle =~ '^(\w{1,})?\!([0-9]{1,})$' ]]; then
			repo=${match[1]:-$DEFAULT_REPO}
			mr_id=$match[2]

			gitlab_url="$MAIN_GITLAB/$repo/merge_requests/$mr_id"
			echo "[$repo!$mr_id|$gitlab_url]"
		elif [[ $handle =~ '^(\w{1,})?\#([0-9]{1,})$' ]]; then
			repo=${match[1]:-$DEFAULT_REPO}
			issue_id=$match[2]

			gitlab_url="$MAIN_GITLAB/$repo/issues/$issue_id"
			echo "[$repo#$issue_id|$gitlab_url]"
		elif [[ $handle =~ '^[0-9a-f]{5,40}$' ]]; then
			commit_hash=$MATCH
			commit_hash_short=$(echo $commit_hash | cut -c1-7)
			gitlab_url="$MAIN_GITLAB/$DEFAULT_REPO/commit/$commit_hash"
			echo "[{{$commit_hash_short}}|$gitlab_url]"
		elif [[ $handle =~ '^T[0-9]{1,6}$' ]]; then
			phabtricator_task_id=$MATCH
			phabtricator_url="$MAIN_PHABRICATOR/$phabtricator_task_id"
			echo "[$phabtricator_task_id|$phabtricator_url]"
		fi
	done
}

function get-mr {
	GITLAB_API_BASE_URL="https://gitlab.mustardsystems.com/api/v4"
	GITLAB_PRIVATE_TOKEN=$(pass show gitlab-private-token)

	commit_hash=$1

	function _http_get {
		curl --header "PRIVATE-TOKEN: $GITLAB_PRIVATE_TOKEN" $1 2>/dev/null | jq -r $2
	}

	colinbet_id=$(_http_get "$GITLAB_API_BASE_URL/projects?search=colinbet" '.[].id')

	mr_urls=$(_http_get "$GITLAB_API_BASE_URL/projects/$colinbet_id/repository/commits/$commit_hash/merge_requests" '.[].web_url')
	echo $mr_urls
}
